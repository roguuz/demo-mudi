pipeline {
    agent any

    tools {
        maven 'maven'
    }
    environment {
        env = "demo"
        tag = "${emv}_${BUILD_ID}"
    }
    stages {
        stage('Build') {
            steps {
                sh (
                    script: '''
                    cd demo-app
                    mvn clean install
                    aws ecr get-login-password --region us-west-1 | docker login --username AWS --password-stdin 219252656223.dkr.ecr.us-west-1.amazonaws.com
                    docker build -t 219252656223.dkr.ecr.us-west-1.amazonaws.com/demo-mudi:${tag} .
                    docker push 219252656223.dkr.ecr.us-west-1.amazonaws.com/demo-mudi:${tag}
                    ''',
                    returnStdout: true
                    )
            }
        }
        stage('Deploy') {
            steps{
                sh (
                    script: '''
                    TASK_DEF=$(aws ecs register-task-definition --family demo-mudi --container-definitions '[{"name": "demo-app","image": "219252656223.dkr.ecr.us-west-1.amazonaws.com/demo-mudi:${tag}"}]' --query 'taskDefinition.revision')
                    aws ecs update-service --cluster demo-mudi --service demo-mudi --task-definition demo-mudi:$TASK_DEF
                    echo "deployed!"
                    ''',
                    returnStdout: true
                )
            }
        }

    }
        post {
            always {
                cleanWs deleteDirs: true, notFailBuild: true
            }
        }
}
